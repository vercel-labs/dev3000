name: Test Clean Installation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-clean-installs:
    strategy:
      matrix:
        os: [macos-latest]
        node: [20]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4

      # Install bun for preinstall script (bunx only-allow pnpm)
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      # Install pnpm
      - uses: pnpm/action-setup@v3
        with:
          version: 10.18.3
      
      # Install dependencies and build
      - run: pnpm install
      - run: pnpm run build
      - run: cd mcp-server && pnpm run build
      - run: pnpm pack
      
      # Test 1: Clean npm global install
      - name: Test Clean NPM Global Install
        run: |
          # Save current directory
          WORK_DIR=$(pwd)
          
          # Create clean environment
          export CLEAN_HOME=$(mktemp -d)
          
          # Get full path to tarball
          TARBALL=$(ls $WORK_DIR/dev3000-*.tgz)
          echo "Installing from tarball: $TARBALL"
          
          # Configure npm to install to clean location
          npm config set prefix $CLEAN_HOME/.npm
          export PATH="$CLEAN_HOME/.npm/bin:$PATH"
          
          # Install globally
          npm install -g "$TARBALL"
          
          # Verify installation
          echo "Checking installation..."
          ls -la $CLEAN_HOME/.npm/bin/
          
          # Test that d3k works
          d3k --version
      
      # Test 2: Server startup test
      - name: Test MCP Server Startup (skipped on CI runners)
        if: ${{ false }}
        run: echo "skip"

  # Docker tests disabled - macOS runners don't have Docker
  # test-docker-install:
  #   runs-on: ubuntu-latest  # Would need Ubuntu for Docker
  #   ... (test commented out)
